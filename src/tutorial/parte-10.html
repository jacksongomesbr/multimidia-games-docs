<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 1</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
        /* Button styling*/
        .button {
            font-size: 1.5em;
            
            cursor: pointer;
            
            width:8em;
            padding: 10px 10px 10px 10px;
            margin: 05px;
            
            background: #ffffff;
            border: solid #CC97FF 2px;
            color: #21572F;
            
            -webkit-border-radius: 10px;
            box-shadow: -5px 5px 0px #773ECD; 
        }
    </style>
</head>

<body>

    <script type="text/javascript">

        var config = {
            type: Phaser.AUTO,
            //Adicionado para criação formulario de entrada 
            parent: 'phaser-example',
            width: 800,
            height: 600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: false
                }
            },
            //A estrutura 'dom' cria uma div do DOM Container posicionada sobre a parte superior da tela do jogo. Essa div é dimensionada para corresponder à tela e, se o tamanho da tela mudar, como resultado das configurações no Scale Manager, o contêiner dom será redimensionado de acordo.
            dom: {
                createContainer: true
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        var nick='';
        var player;
        var stars;
        var bombs;
        var platforms;
        var cursors;
        var score = 0;
        var gameOver = false;
        var scoreText;
        var rank;
        var iniciar = false;

        var game = new Phaser.Game(config);


        function preload() {
            // Carrega template html de entrada de nick
            this.load.html('nameform', 'assets/nameform.html');
            // Carrega template html de entrada de nick
            this.load.html('buttonreset', 'assets/buttonreset.html');
            // Imagem de fundo rank
            this.load.image('rank', 'assets/rank.png');

            this.load.image('sky', 'assets/sky.png');
            this.load.image('ground', 'assets/platform.png');
            this.load.image('star', 'assets/star.png');
            this.load.image('bomb', 'assets/bomb.png');
            this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
        }

        function create() {
            
            this.add.image(400, 300, 'sky');

            platforms = this.physics.add.staticGroup();

            platforms.create(400, 568, 'ground').setScale(2).refreshBody();

            platforms.create(600, 400, 'ground');
            platforms.create(50, 250, 'ground');
            platforms.create(750, 220, 'ground');

            player = this.physics.add.sprite(100, 450, 'dude');

            player.setBounce(0.2);
            player.setCollideWorldBounds(true);

            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });

            this.anims.create({
                key: 'turn',
                frames: [{ key: 'dude', frame: 4 }],
                frameRate: 20
            });

            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });
            
            cursors = this.input.keyboard.createCursorKeys();

            stars = this.physics.add.group({
                key: 'star',
                repeat: 11,
                setXY: { x: 12, y: 0, stepX: 70 }
            });

            stars.children.iterate(function (child) {
                child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
            });

            bombs = this.physics.add.group();

            scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

            this.physics.add.collider(player, platforms);
            this.physics.add.collider(stars, platforms);
            this.physics.add.collider(bombs, platforms);

            this.physics.add.overlap(player, stars, collectStar, null, this);
            this.physics.add.collider(player, bombs, hitBomb, null, this);

            // Formulario de entrada nick 
            var element = this.add.dom(400, 0).createFromCache('nameform');
            element.addListener('click');
            element.on('click', function (event) {
                if (event.target.name === 'playButton'){
                    var valorentrada = this.getChildByName('valor');
                    nick=valorentrada.value;
                    if (valorentrada.value !== ''){
                //  Desativar os eventos de clique
                        this.removeListener('click');
                //  Ocultar o elemento de login
                        this.setVisible(false);
                        iniciar = true;
                    }else{
                        // Pisca o prompt
                        this.scene.tweens.add({
                        targets: text,
                        alpha: 0.2,
                        duration: 250,
                        ease: 'Power3',
                        yoyo: true
                        });
                    }
                }
            });

            this.tweens.add({
                targets: element,
                y: 300,
                duration: 0,
                ease: 'Power3'
                });
        }

        function update() {
            if (gameOver) {
                return;
            }
            if (iniciar == true){           
                if (cursors.left.isDown) {
                    player.setVelocityX(-160);
                    player.anims.play('left', true);
                }
                else if (cursors.right.isDown) {
                    player.setVelocityX(160);
                    player.anims.play('right', true);
                }
                else {
                    player.setVelocityX(0);
                    player.anims.play('turn');
                }

                if (cursors.up.isDown && player.body.touching.down) {
                    player.setVelocityY(-330);
                }
            }
 
        }

        function collectStar(player, star) {
            star.disableBody(true, true);

            score += 10;
            scoreText.setText('Score: ' + score);

            if (stars.countActive(true) === 0) {
                stars.children.iterate(function (child) {
                    child.enableBody(true, child.x, 0, true, true);
                });

                var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

                var bomb = bombs.create(x, 16, 'bomb');
                bomb.setBounce(1);
                bomb.setCollideWorldBounds(true);
                bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                bomb.allowGravity = false;
            }

            localStorage.setItem(nick,score);
        }

        function rank_jogador(){
            // pega valores do localStorage e armazena em variavel rank
            var rank = [];
            if(localStorage.length>0){
                for(i=0; i<localStorage.length;i++){
                    rank.push({jogador:localStorage.key(i),pontuacao:localStorage.getItem(localStorage.key(i))});
                }
            }

            // Função ordena em ordem crescente
            rank.sort(function (a, b) {
                if (a.pontuacao < b.pontuacao) {
                    return 1;
                }
                if (a.pontuacao > b.pontuacao) {
                    return -1;
                }
                // a must be equal to b
                return 0;
            });


            return rank;
        }

        function hitBomb(player, bomb) {
            this.add.image(400, 300, 'rank');

            // Text rank top 10
            rankExibicao = this.add.text(400, 195, 'RANK TOP 10', { fontSize: '20px', fill: '#000' });
            rankExibicao.setOrigin(0.5);

            // Variavel para exibição dos resultados dos 10 melhores
            rankExibicao = this.add.text(400, 330, '', { fontSize: '19px', fill: '#000' });
            rankExibicao.setOrigin(0.5);


            // Varivel jogadores recebe lista ordenada da função rank_jogador
            var jogadores = rank_jogador();
            // Seta os 10 melhores jogadores para uma nova variavel que será exibido em tela
            var rank = [];
            if(jogadores.length>=10){
                for(i=0;i<10;i++){
                    rank.push(['Jogador: ' + jogadores[i].jogador + ' ('+ jogadores[i].pontuacao] + ' pontos)');
                }
            }else{
                for(i=0;i<jogadores.length;i++){
                    rank.push(['Jogador: ' + jogadores[i].jogador + ' ('+ jogadores[i].pontuacao] + ' pontos)');
                }
            }
            
            // Manda para exibição
            rankExibicao.setText(rank);


            // Cria button de reset
            var btn = this.add.dom(400, 470).createFromCache('buttonreset');   
            btn.addListener('click');
            btn.on('click', function (event) {
            // Recarrega a página
                location.reload();
            });

            
            

            this.physics.pause();
            player.setTint(0xff0000);
            player.anims.play('turn');
            gameOver = true;
        }

    </script>



</body>

</html>


<!-- Site referência entrada de dados https://labs.phaser.io/edit.html?src=src/game%20objects/dom%20element/input%20test.js&v=3.20.0  -->
<!-- Site referência entrada de dados https://rexrainbow.github.io/phaser3-rex-notes/docs/site/domelement/ -->
<!-- Site referência Salvar local storage https://www.youtube.com/watch?v=CSfpEMWHnYg -->
<!-- Site referência Ordenação https://developer.mozilla.org/pt-BR/docs/Web/JavaScript/Reference/Global_Objects/Array/sort -->